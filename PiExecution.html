<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Pi-Calculus</title>
	<script src="PiExecution.js" type="text/javascript"></script>
	<script src="PiExecution_drawing.js" type="text/javascript"></script>
	<script src="PiExecution_utilities.js" type="text/javascript"></script>
</head>
<body>
	<canvas id="myCanvas" width="815" height="340" style="border:1px solid black;">
		Your browser does not support the canvas element.
	</canvas>

	<script>
		// Get the URL parameters **************************************************
		startNode = getUrlVars()["start"];
		main_document=getUrlVars()["main_document"];
		var picode = decodeURIComponent(getUrlVars()["picode"]); // get picode
		var picode_array = picode.split('\n'); // split it up into lines

		// Delete unused lines ****************************************************
		for(var i=0;i<picode_array.length;i++){
			if (picode_array[i].length<=2){
				picode_array.splice(i, i); // delete element without leaving a hole
			}
		}

		// Check that there are only 6 lines **************************************
		if (picode_array.length>6){
			alert("ERROR too many lines only 6 are allowed!");
			window.history.back();
		}

		// Create all process objects *************************************
		for(var i=0;i<picode_array.length;i++){
			var line_equal_array = picode_array[i].split('=');
			var tempObj=new ProcessDefinition(line_equal_array[0],line_equal_array[1],-1,-1, new Array(), -1);
			process_array.push(tempObj); // add the current process to the process array
		}

		// Parse all objects ************************************************
		for(var i=0;i<process_array.length;i++){
			parsingALine(process_array[i]);
		}

		// Brings it in the right order
		process_array.reverse();

		// CANVAS *********************************************************
		var canvas = document.getElementById("myCanvas");
		var ctx = canvas.getContext("2d");

		ctx.font = "30px Arial";
		ctx.fillStyle = '#000000';

		// Create a headline --------------------------
		var headline="";
		for(var i=0;i<process_array.length;i++){
			headline=headline+process_array[i].process+"->";
		}
		headline=headline.substr(0, headline.length-2);
		ctx.strokeText(headline, 5, 30);

		// create the use cases and the objects --------
		var a=100;
		var b=55;
		for(var i=0;i<process_array.length;i++){
			if (process_array[i].process==startNode){
				drawUseCase(ctx, 5, 40);
				process_array[i].x_coord=5;
				process_array[i].y_coord=40
			}else{
				drawBoxWithTextAndSwimLane(ctx, a, b, process_array[i].process);
				process_array[i].x_coord=a;
				process_array[i].y_coord=b;
				a+=150;
			}
		}

		// ***************************************************************************************************
		// Difficult part ************************************************************************************
		// Draw lines ****************************************************************************************
		var process_array_clone = process_array.slice(0); // clone array
		var myAddX=50; // start coordinates for the line drawing
		var myAddY=100;

		// step 1 --------------------------------------------------------------------------------------------
		// Draw from useCase to the first object --- there is no real hint in the pi-calculus notation, but it makes sense in a sequence diagram
		// Create a data object
		var docLink0={
			processDef_from:process_array_clone[0],
			processDef_to:process_array_clone[1],
			which_channel_from:null,
			which_channel_next:null,
			text:"create("+main_document+")"
		};

		drawLineWithText(
			docLink0.processDef_from.x_coord+20, docLink0.processDef_from.y_coord+115,
			docLink0.processDef_to.x_coord+myAddX, docLink0.processDef_to.y_coord+myAddY,
			docLink0.text);

		// step 2 --------------------------------------------------------------------------------------------
		// Create a data object
		var docLink1={
			processDef_from:null,
			processDef_to:null,
			which_channel_from:null,
			which_channel_next:null,
			text:"send("+main_document+")"
		};

		// Search for the first doc occurence
		var i=1;
		for(;i<process_array_clone.length;i++){
			// search for the document
			if (process_array_clone[i].searchForDoc(main_document)==true){
				docLink1.processDef_from=process_array[i];
				break;
			}
		}

		// Get the channel assigned to this document
		docLink1.which_channel_from=docLink1.processDef_from.getFirstChannelFromTheBack();

		// Search in the following processDefs for the same channel
		for(;i<process_array_clone.length;i++){
			var isContainingChannel=process_array_clone[i].containsChannel(docLink1.which_channel_from);
			if (isContainingChannel==true){
				docLink1.processDef_to=process_array_clone[i];
			}
		}

		// Draw a line
		myAddY+=10; // make it a more visible that we have different lines
		drawLineWithText(
			docLink1.processDef_from.x_coord+myAddX, docLink1.processDef_from.y_coord+myAddY,
			docLink1.processDef_to.x_coord+myAddX, docLink1.processDef_to.y_coord+myAddY,
			docLink1.text);

		// step 3 -----------------------------------------------------------------------------------------
		// Get from server the next link
		// Create a data object
		var docLink2={
			processDef_from:null,
			processDef_to:null,
			which_channel_from:docLink1.processDef_to.getChannelAfterExclamationMark(docLink1.which_channel_from),
			which_channel_next:docLink1.processDef_to.getChannelAfterExclamationMark(docLink1.which_channel_from),
			text:"send("+main_document+")"
		};

		var isFirst=true;
		for(i=1;i<process_array_clone.length;i++){
			if (process_array_clone[i].containsChannel(docLink2.which_channel_next)){
				if (isFirst==true){
					isFirst=false;
					docLink2.processDef_from=process_array_clone[i];
				}else{ // wait for the first occurence
					docLink2.processDef_to=process_array_clone[i];
					docLink2.text=process_array_clone[i].docContainsFunction().toString();
					break;
				}
			}
		}

		// Draw a line
		myAddY+=10; // make it a more visible that we have different lines
		drawLineWithText(
			docLink2.processDef_from.x_coord+myAddX, docLink2.processDef_from.y_coord+myAddY,
			docLink2.processDef_to.x_coord+myAddX, docLink2.processDef_to.y_coord+myAddY,
			docLink2.text);

		// step 4 are there more functions ----------------------------------------------------------------------
		for(i=1;i<process_array_clone.length;i++){
			if (process_array_clone[i].boolContainsFunction() && process_array_clone[i].process!=docLink2.processDef_to.process){
				//alert("YEAAAHHHHHH="+process_array_clone[i].process+" == "+docLink2.processDef_to.process);

				// Draw a line
				myAddY+=25; // make it a more visible that we have different lines
				drawLineWithText(
				docLink2.processDef_from.x_coord+myAddX, docLink2.processDef_from.y_coord+myAddY,
				process_array_clone[i].x_coord+myAddX,process_array_clone[i].y_coord+myAddY,
				process_array_clone[i].docContainsFunction().toString());

				break;
			}
		}
	</script>
	<p>
		<hr>
		<b>Original Version:</b><br>
		<script>
			// Print out the original version
			for(var i=0;i<picode_array.length;i++){
				document.writeln(picode_array[i]+"<br>");
			}
		</script>
		<hr>
		<b>Parsed Version:</b><br>
		<script>
			for(var i=0;i<process_array.length;i++){
				document.write(process_array[i]);
			}
		</script>
		<hr>
	</p>
	<button onclick="goBack()">Go Back</button>
</body>
</html>