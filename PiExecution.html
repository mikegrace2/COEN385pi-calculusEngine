<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Pi-Calculus</title>
	<script src="PiCalculus.js" type="text/javascript"></script>
</head>
<body>
	<canvas id="myCanvas" width="815" height="340" style="border:1px solid black;">
		Your browser does not support the canvas element.
	</canvas>

	<script>
		// Get the URL parameters **************************************************
		startNode = getUrlVars()["start"];
		main_document=getUrlVars()["main_document"];
		var picode = decodeURIComponent(getUrlVars()["picode"]); // get picode
		var picode_array = picode.split('\n'); // split it up into lines

		// Delete unused lines ****************************************************
		for(var i=0;i<picode_array.length;i++){
			if (picode_array[i].length<=2){
				picode_array.splice(i, i); // delete element without leaving a hole
			}
		}

		// Check that there are only 6 lines **************************************
		if (picode_array.length>6){
			alert("ERROR too many lines only 6 are allowed!");
			window.history.back();
		}

		// Create all process objects *************************************
		for(var i=0;i<picode_array.length;i++){
			var line_equal_array = picode_array[i].split('=');
			var tempObj=new ProcessDefinition(line_equal_array[0],line_equal_array[1],-1,-1, new Array(), -1);
			process_array.push(tempObj); // add the current process to the process array
		}

		// Parse all objects ************************************************
		for(var i=0;i<process_array.length;i++){
			parsingALine(process_array[i]);
		}

		// Brings it in the right order
		process_array.reverse();

		// CANVAS *********************************************************
		var canvas = document.getElementById("myCanvas");
		var ctx = canvas.getContext("2d");

		ctx.font = "30px Arial";
		ctx.fillStyle = '#000000';

		// Create a headline --------------------------
		var headline="";
		for(var i=0;i<process_array.length;i++){
			headline=headline+process_array[i].process+"->";
		}
		headline=headline.substr(0, headline.length-2);
		ctx.strokeText(headline, 5, 30);

		// create the use cases and the objects --------
		var a=100;
		var b=55;
		for(var i=0;i<process_array.length;i++){
			if (process_array[i].process==startNode){
				drawUseCase(ctx, 5, 40);
				process_array[i].x_coord=5;
				process_array[i].y_coord=40
			}else{
				drawBoxWithTextAndSwimLane(ctx, a, b, process_array[i].process);
				process_array[i].x_coord=a;
				process_array[i].y_coord=b;
				a+=150;
			}
		}

		// ***************************************************************************************************
		// Create lines **************************************************************************************
		var process_array_clone = process_array.slice(0);

		// 1. search for the document in the first elements
		var docLink={
			processDef_from:null,
			processDef_to:null,
			which_channel_from:null,
			which_channel_next:null
		};

		// Search for the first doc occurence
		for(var i=1;i<process_array_clone.length;i++){
			// search for the document
			if (process_array_clone[i].searchForDoc()==true){
				// First hit is the right one
				docLink.processDef_from=process_array[i];
				process_array_clone.splice(i, i);
				//alert("processDef has doc inside="+docLink.processDef_from.process);
				break;
			}
		}

		// Get the channel assigned to this document
		docLink.which_channel_from=docLink.processDef_from.getFirstChannelFromTheBack();

		// Search in the following processDefs for the same channel
		for(var i=1;i<process_array_clone.length;i++){
			var isContainingChannel=process_array_clone[i].containsChannel(docLink.which_channel_from);
			if (isContainingChannel==true){
				docLink.processDef_to=process_array_clone[i];
				//alert("PROCESS="+process_array_clone[i].process+" has channel="+docLink.which_channel_from);
			}
		}

		//alert("Draw a line from "+docLink.processDef_from.process+" to "+docLink.processDef_to.process);
		var myAddX=50;
		var myAddY=100;

		// Draw from use case to client
		drawLineWithText(
			process_array_clone[0].x_coord+20, process_array_clone[0].y_coord+115,
			docLink.processDef_from.x_coord+myAddX, docLink.processDef_from.y_coord+myAddY,
			"create("+main_document+")");

		// Draw client to server
		myAddY+=10;
		drawLineWithText(
			docLink.processDef_from.x_coord+myAddX, docLink.processDef_from.y_coord+myAddY,
			docLink.processDef_to.x_coord+myAddX, docLink.processDef_to.y_coord+myAddY,
			"send("+main_document+")");

		// ***************************************************************************************************
		// Next step get the next link ***********************************************************************
		// Get from server the next link
		docLink.which_channel_next=docLink.processDef_to.getChannelAfterExclamationMark(docLink.which_channel_from);
		//alert('Next channel to find='+docLink.which_channel_next);

		// Search for the two processDefs which contains the channel
		var docLink2={
			processDef_from:null,
			processDef_to:null,
			which_channel_from:docLink.which_channel_next,
			which_channel_next:docLink.which_channel_next
		};

		var isFirst=true;
		var containsFunction="send";
		for(var i=1;i<process_array_clone.length;i++){
			//alert("process="+process_array_clone[i].process);
			if (process_array_clone[i].containsChannel(docLink.which_channel_next)){
				if (isFirst==true){
					//alert("YES process1="+process_array_clone[i].process+" has channel="+docLink.which_channel_next);
					isFirst=false;
					docLink2.processDef_from=process_array_clone[i];
				}else{
					//alert("YES process2="+process_array_clone[i].process+" has channel="+docLink.which_channel_next);
					docLink2.processDef_to=process_array_clone[i];
					containsFunction=process_array_clone[i].containsFunction();
				}
			}
		}

		// Draw client to server
		myAddY+=10;
		drawLineWithText(
			docLink2.processDef_from.x_coord+myAddX, docLink2.processDef_from.y_coord+myAddY,
			docLink2.processDef_to.x_coord+myAddX, docLink2.processDef_to.y_coord+myAddY,
			containsFunction+"("+main_document+")");
	</script>
	<p>
		<hr>
		<b>Original Version:</b><br>
		<script>
			// Print out the original version
			for(var i=0;i<picode_array.length;i++){
				document.writeln(picode_array[i]+"<br>");
			}
		</script>
		<hr>
		<b>Parsed Version:</b><br>
		<script>
			for(var i=0;i<process_array.length;i++){
				document.write(process_array[i]);
			}
		</script>
		<hr>
	</p>
	<button onclick="goBack()">Go Back</button>
</body>
</html>